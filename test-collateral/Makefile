#Â Makefile for test-collateral generation
#
# AUTHORS
#
# The Veracruz Development Team.
#
# COPYRIGHT
#
# See the `LICENSE.markdown` file in the Veracruz root directory for licensing
# and copyright information.

.PHONY: all policy-files clean


WARNING_COLOR := "\e[1;33m"
INFO_COLOR := "\e[1;32m"
RESET_COLOR := "\e[0m"

POLICY_FILES ?= get_random_policy.json \
 				one_data_source_policy.json \
				two_data_source_string_edit_distance_policy.json \
				two_data_source_intersection_set_policy.json \
				two_data_source_private_set_intersection_policy.json \
				dual_policy.json \
				triple_policy.json \
 				triple_parties_two_data_sources_sum_policy.json \
				permuted_triple_parties_two_data_sources_sum_policy.json \
				triple_parties_two_data_sources_string_edit_distance_policy.json \
				dual_parallel_policy.json \
				quadruple_policy.json \
				test_multiple_key_policy.json \
 				idash2017_logistic_regression_policy.json \
				moving_average_convergence_divergence.json \
 				private_set_intersection_sum.json

WASM_PROG_FILES = random-source.wasm \
				  linear-regression.wasm \
				  string-edit-distance.wasm \
				  intersection-set-sum.wasm \
				  private-set-intersection.wasm \
				  idash2017-logistic-regression.wasm \
				  moving-average-convergence-divergence.wasm \
				  private-set-intersection-sum.wasm 

DATA_FILES = linear-regression.dat \
 			 hello-world-1.dat \
 			 hello-world-2.dat \
			 intersection-customer.dat \
             intersection-advertisement-viewer.dat \
			 private-set-1.dat \
			 private-set-2.dat


all: policy-files $(WASM_PROG_FILES) $(DATA_FILES)

policy-files: $(POLICY_FILES)
	@echo $(INFO_COLOR)"GEN   =>  $(POLICY_FILES)"$(RESET_COLOR)

# the css.bin and hash.bin are generated by running "make sgx" in under sinaloa
../mexico-city/css.bin: 
	$(MAKE) clean -C ../mexico-city
	$(MAKE) css.bin -C ../mexico-city

css.bin: ../mexico-city/css.bin
	cp $< $@

get_random_policy.json: policy.template css.bin client_rsa_cert.pem random-source.wasm generate_policy.py
	python ./generate_policy.py --template-file policy.template \
                --identity client_rsa_cert.pem "\"PiProvider\", \"ResultReader\"" \
                --sinaloa-url 127.0.0.1:3011 --tabasco-url 127.0.0.1:3010 --output-policy-file $@ --certificate-lifetime-in-hours 8760 \
				--pi-binary random-source.wasm --debug-flag True --execution-strategy "\"Interpretation\""

one_data_source_policy.json: policy.template css.bin client_rsa_cert.pem linear-regression.wasm generate_policy.py
	python ./generate_policy.py --data-provision-order 0 --template-file policy.template \
		--identity client_rsa_cert.pem "\"PiProvider\", \"DataProvider\", \"ResultReader\"" \
		--sinaloa-url 127.0.0.1:3012 --tabasco-url 127.0.0.1:3010 --output-policy-file $@ --certificate-lifetime-in-hours 8760 \
		--pi-binary linear-regression.wasm --execution-strategy "\"Interpretation\""

test_multiple_key_policy.json: policy.template css.bin client_rsa_cert.pem moving-average-convergence-divergence.wasm generate_policy.py
	python ./generate_policy.py --data-provision-order 0 --template-file policy.template \
		--identity client_rsa_cert.pem "\"PiProvider\", \"DataProvider\", \"ResultReader\"" \
		--sinaloa-url 127.0.0.1:3012 --tabasco-url 127.0.0.1:3010 --output-policy-file $@ --certificate-lifetime-in-hours 8760 \
		--pi-binary moving-average-convergence-divergence.wasm --execution-strategy "\"Interpretation\""

two_data_source_string_edit_distance_policy.json: policy.template css.bin client_rsa_cert.pem string-edit-distance.wasm generate_policy.py
	python ./generate_policy.py --data-provision-order 0 0  --template-file policy.template \
		--identity client_rsa_cert.pem "\"PiProvider\", \"DataProvider\", \"ResultReader\"" \
		--sinaloa-url 127.0.0.1:3013 --tabasco-url 127.0.0.1:3010 --output-policy-file $@ --certificate-lifetime-in-hours 8760 \
		--pi-binary string-edit-distance.wasm --execution-strategy "\"Interpretation\""

two_data_source_intersection_set_policy.json: policy.template css.bin client_rsa_cert.pem intersection-set-sum.wasm generate_policy.py
	python ./generate_policy.py --data-provision-order 0 0  --template-file policy.template \
		--identity client_rsa_cert.pem "\"PiProvider\", \"DataProvider\", \"ResultReader\"" \
		--sinaloa-url 127.0.0.1:3022 --tabasco-url 127.0.0.1:3010 --output-policy-file $@ --certificate-lifetime-in-hours 8760 \
		--pi-binary intersection-set-sum.wasm --execution-strategy "\"Interpretation\""

two_data_source_private_set_intersection_policy.json: policy.template css.bin client_rsa_cert.pem private-set-intersection.wasm generate_policy.py
	python ./generate_policy.py --data-provision-order 0 0  --template-file policy.template \
		--identity client_rsa_cert.pem "\"PiProvider\", \"DataProvider\", \"ResultReader\"" \
		--sinaloa-url 127.0.0.1:3026 --tabasco-url 127.0.0.1:3010 --output-policy-file $@ --certificate-lifetime-in-hours 8760 \
		--pi-binary private-set-intersection.wasm --execution-strategy "\"Interpretation\""

dual_policy.json: policy.template css.bin program_client_cert.pem data_client_cert.pem linear-regression.wasm generate_policy.py
	python ./generate_policy.py --data-provision-order 1 --template-file policy.template \
		--identity program_client_cert.pem "\"PiProvider\"" \
		--identity data_client_cert.pem "\"DataProvider\", \"ResultReader\"" \
		--sinaloa-url 127.0.0.1:3014 --tabasco-url 127.0.0.1:3010 --output-policy-file $@ --certificate-lifetime-in-hours 8760 \
		--pi-binary linear-regression.wasm --execution-strategy "\"Interpretation\""

dual_parallel_policy.json: policy.template css.bin program_client_cert.pem data_client_cert.pem linear-regression.wasm generate_policy.py
	python ./generate_policy.py --data-provision-order 1  --template-file policy.template \
		--identity program_client_cert.pem "\"PiProvider\"" \
		--identity data_client_cert.pem "\"DataProvider\", \"ResultReader\"" \
		--sinaloa-url 127.0.0.1:3015 --tabasco-url 127.0.0.1:3010 --output-policy-file $@ --certificate-lifetime-in-hours 8760 \
		--pi-binary linear-regression.wasm --execution-strategy "\"Interpretation\""

triple_policy.json: policy.template css.bin program_client_cert.pem data_client_cert.pem result_client_cert.pem linear-regression.wasm generate_policy.py
	python ./generate_policy.py --data-provision-order 1 --template-file policy.template \
		--identity program_client_cert.pem "\"PiProvider\"" \
		--identity data_client_cert.pem "\"DataProvider\", \"ResultReader\"" \
		--identity result_client_cert.pem "\"ResultReader\"" \
		--sinaloa-url 127.0.0.1:3016 --tabasco-url 127.0.0.1:3010 --output-policy-file $@ --certificate-lifetime-in-hours 8760 \
		--pi-binary linear-regression.wasm --execution-strategy "\"Interpretation\""

triple_parties_two_data_sources_sum_policy.json: policy.template css.bin program_client_cert.pem data_client_cert.pem result_client_cert.pem intersection-set-sum.wasm generate_policy.py
	python ./generate_policy.py --data-provision-order 1 2 --template-file policy.template \
		--identity program_client_cert.pem "\"PiProvider\"" \
		--identity data_client_cert.pem "\"DataProvider\"" \
		--identity result_client_cert.pem "\"DataProvider\", \"ResultReader\"" \
		--sinaloa-url 127.0.0.1:3017 --tabasco-url 127.0.0.1:3010 --output-policy-file $@ --certificate-lifetime-in-hours 8760 \
		--pi-binary intersection-set-sum.wasm --execution-strategy "\"Interpretation\""

permuted_triple_parties_two_data_sources_sum_policy.json: policy.template css.bin program_client_cert.pem data_client_cert.pem result_client_cert.pem intersection-set-sum.wasm generate_policy.py
	python ./generate_policy.py --data-provision-order 1 2 --template-file policy.template \
		--identity program_client_cert.pem "\"PiProvider\"" \
		--identity data_client_cert.pem "\"DataProvider\"" \
		--identity result_client_cert.pem "\"DataProvider\", \"ResultReader\"" \
		--sinaloa-url 127.0.0.1:3018 --tabasco-url 127.0.0.1:3010 --output-policy-file $@ --certificate-lifetime-in-hours 8760 \
		--pi-binary intersection-set-sum.wasm --execution-strategy "\"Interpretation\""

triple_parties_two_data_sources_string_edit_distance_policy.json: policy.template css.bin program_client_cert.pem data_client_cert.pem result_client_cert.pem string-edit-distance.wasm generate_policy.py
	python ./generate_policy.py --data-provision-order 1 2 --template-file policy.template \
		--identity program_client_cert.pem "\"PiProvider\"" \
		--identity data_client_cert.pem "\"DataProvider\"" \
		--identity result_client_cert.pem "\"DataProvider\", \"ResultReader\"" \
		--sinaloa-url 127.0.0.1:3019 --tabasco-url 127.0.0.1:3010 --output-policy-file $@ --certificate-lifetime-in-hours 8760 \
		--pi-binary string-edit-distance.wasm --execution-strategy "\"Interpretation\""

quadruple_policy.json: policy.template css.bin program_client_cert.pem data_client_cert.pem result_client_cert.pem string-edit-distance.wasm generate_policy.py
	python ./generate_policy.py --data-provision-order 1 2 --template-file policy.template \
		--identity program_client_cert.pem "\"PiProvider\"" \
		--identity data_client_cert.pem "\"DataProvider\"" \
		--identity never_used_cert.pem "\"DataProvider\"" \
		--identity result_client_cert.pem "\"ResultReader\"" \
		--sinaloa-url 127.0.0.1:3020 --tabasco-url 127.0.0.1:3010 --output-policy-file $@ --certificate-lifetime-in-hours 8760 \
		--pi-binary string-edit-distance.wasm --execution-strategy "\"Interpretation\""

invalid_policy/one_expired_data_source_policy.json: policy.template css.bin expired_cert.pem linear-regression.wasm generate_policy.py
	python ./generate_policy.py --data-provision-order 0 --template-file policy.template \
		--identity expired_cert.pem "\"PiProvider\", \"DataProvider\", \"ResultReader\"" \
		--sinaloa-url 127.0.0.1:3021 --tabasco-url 127.0.0.1:3010 --output-policy-file $@ --certificate-lifetime-in-hours 8760 \
		--pi-binary linear-regression.wasm --execution-strategy "\"Interpretation\""

idash2017_logistic_regression_policy.json: policy.template css.bin client_rsa_cert.pem idash2017-logistic-regression.wasm generate_policy.py
	python ./generate_policy.py --data-provision-order 0 --template-file policy.template \
		--identity client_rsa_cert.pem "\"PiProvider\", \"DataProvider\", \"ResultReader\"" \
		--sinaloa-url 127.0.0.1:3023 --tabasco-url 127.0.0.1:3010 --output-policy-file $@ --certificate-lifetime-in-hours 8760 \
		--pi-binary idash2017-logistic-regression.wasm --execution-strategy "\"Interpretation\""

moving_average_convergence_divergence.json: policy.template css.bin client_rsa_cert.pem moving-average-convergence-divergence.wasm generate_policy.py
	python ./generate_policy.py --data-provision-order 0 --template-file policy.template \
		--identity client_rsa_cert.pem "\"PiProvider\", \"DataProvider\", \"ResultReader\"" \
		--sinaloa-url 127.0.0.1:3024 --tabasco-url 127.0.0.1:3010 --output-policy-file $@ --certificate-lifetime-in-hours 8760 \
		--pi-binary moving-average-convergence-divergence.wasm --execution-strategy "\"Interpretation\""

private_set_intersection_sum.json: policy.template css.bin client_rsa_cert.pem private-set-intersection-sum.wasm generate_policy.py
	python ./generate_policy.py --data-provision-order 0 --template-file policy.template \
		--identity client_rsa_cert.pem "\"PiProvider\", \"DataProvider\", \"ResultReader\"" \
		--sinaloa-url 127.0.0.1:3025 --tabasco-url 127.0.0.1:3010 --output-policy-file $@ --certificate-lifetime-in-hours 8760 \
		--pi-binary private-set-intersection-sum.wasm --execution-strategy "\"Interpretation\""

.SECONDEXPANSION:
$(WASM_PROG_FILES) : %.wasm: ../sdk/examples/%/target/wasm32-arm-veracruz/release/$$@
	cp $< $@

$(DATA_FILES) : %.dat: ../sdk/datasets/%.dat 
	cp $< $@

clean:
	rm -f *.json
	rm -f css.bin
	rm -f *.dat
	rm -f *.wasm
